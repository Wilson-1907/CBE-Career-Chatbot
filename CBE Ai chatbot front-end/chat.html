<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Career Chat - CBE Career Guide</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #5D5CDE;
            --secondary: #FF6B35;
            --accent: #4ECDC4;
            --success: #45B7D1;
            --code-champ-blue: #5D5CDE;
            --code-champ-green: #10B981;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6efff 50%, #f0f8ff 100%);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        .gradient-code-champ {
            background: linear-gradient(135deg, var(--code-champ-blue) 0%, var(--code-champ-green) 100%);
        }
        
        .chat-message {
            animation: slideUp 0.3s ease-out;
        }
        
        .typing-indicator {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--primary);
            border-color: var(--primary);
            opacity: 0.9;
        }
        
        .text-primary {
            color: var(--primary) !important;
        }
        
        .navbar {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9) !important;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: linear-gradient(to bottom, #f8f9fa, #ffffff);
        }
        
        .chat-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-pill {
            transition: all 0.3s ease;
        }
        
        .suggestion-pill:hover {
            transform: scale(1.05);
        }
        
        .footer {
            background-color: #212529;
        }
        
        .code-champ-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .error-message {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .loading-pulse {
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top border-bottom">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="/images/code champ logo.jpg" 
                     alt="Code Champ Logo" class="code-champ-logo me-3">
                <div>
                    <span class="fw-bold fs-4 text-primary">CBE Career Guide</span>
                    <div class="small text-muted d-none d-sm-block">
                        <span data-en="A Code Champ Project" data-sw="Mradi wa Code Champ">A Code Champ Project</span>
                    </div>
                </div>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="chat.html">
                            <i class="fas fa-comments me-2"></i>
                            <span data-en="AI Chat" data-sw="Mazungumzo ya AI">AI Chat</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="assessment.html">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <span data-en="Assessment" data-sw="Tathmini">Assessment</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="pathways.html">
                            <i class="fas fa-route me-2"></i>
                            <span data-en="Pathways" data-sw="Njia">Pathways</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="careers.html">
                            <i class="fas fa-briefcase me-2"></i>
                            <span data-en="Careers" data-sw="Kazi">Careers</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="scenarios.html">
                            <i class="fas fa-gamepad me-2"></i>
                            <span data-en="Scenarios" data-sw="Hali">Scenarios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resources.html">
                            <i class="fas fa-book me-2"></i>
                            <span data-en="Resources" data-sw="Rasilimali">Resources</span>
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <select id="languageSelect" onchange="changeLanguage()" class="form-select form-select-sm me-3" style="width: auto;">
                        <option value="en">🇬🇧 English</option>
                        <option value="sw">🇰🇪 Kiswahili</option>
                    </select>
                    
                    <div id="authSection" class="d-none">
                        <div id="notLoggedIn" class="d-flex gap-2">
                            <a href="login.html" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-sign-in-alt me-1"></i>
                                <span data-en="Login" data-sw="Ingia">Login</span>
                            </a>
                            <a href="signup.html" class="btn btn-primary btn-sm">
                                <i class="fas fa-user-plus me-1"></i>
                                <span data-en="Sign Up" data-sw="Jisajili">Sign Up</span>
                            </a>
                        </div>
                        
                        <div id="loggedIn" class="d-none">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user me-1"></i>
                                    <span id="userName">Student</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user me-2"></i>Profile
                                    </a></li>
                                    <li><a class="dropdown-item" href="history.html">
                                        <i class="fas fa-history me-2"></i>History
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="signOut()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Sign Out
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                
                <!-- Enhanced AI Chat Section -->
                <div class="card chat-card rounded-4 overflow-hidden shadow-lg">
                    
                    <!-- Chat Header -->
                    <div class="gradient-bg text-white position-relative overflow-hidden">
                        <img src="/images/student-programing-coding-system-while-girl-enter-metaverse-edification_31965-311768.jpg" 
                             alt="AI technology" 
                             class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover opacity-10">
                        
                        <div class="position-relative p-4 p-md-5">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h2 class="h3 fw-bold d-flex align-items-center mb-3">
                                        <div class="bg-white bg-opacity-20 rounded-3 p-3 me-3">
                                            <i class="fas fa-robot text-white fs-4"></i>
                                        </div>
                                        <span data-en="CBE Career AI Assistant" data-sw="Msaidizi wa AI wa Kazi za CBE">CBE Career AI Assistant</span>
                                    </h2>
                                    <p class="mb-0 opacity-90 fs-5">
                                        <span data-en="Get personalized career guidance based on Kenya's CBE curriculum and pathways!" 
                                              data-sw="Pata mwongozo wa kibinafsi wa kazi kulingana na mtaala wa CBE wa Kenya na njia!">
                                            Get personalized career guidance based on Kenya's CBE curriculum and pathways!
                                        </span>
                                    </p>
                                </div>
                                <div class="d-none d-md-block">
                                    <div class="bg-white bg-opacity-10 rounded-3 p-3 position-relative overflow-hidden" style="width: 96px; height: 96px;">
                                        <img src="/images/code champ logo.jpg" 
                                             alt="Code Champ Logo" 
                                             class="position-absolute top-0 start-0 w-100 h-100 object-fit-cover opacity-75 rounded-3">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat Stats -->
                            <div class="text-center mt-4" id="chatStats">
                                <div class="bg-white bg-opacity-20 rounded-pill px-4 py-2 d-inline-block">
                                    <small>
                                        <span data-en="Messages in this session:" data-sw="Ujumbe katika kipindi hiki:">Messages in this session:</span>
                                        <span id="messageCount" class="fw-bold ms-1">0</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Backend Status Indicator -->
                            <div class="text-center mt-2">
                                <div id="backendStatus" class="bg-white bg-opacity-20 rounded-pill px-3 py-1 d-inline-block">
                                    <small>
                                        <i id="statusIcon" class="fas fa-circle text-success me-1"></i>
                                        <span id="statusText">Backend Connected</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Container -->
                    <div id="chatContainer" class="chat-container p-4 border-bottom">
                        <!-- Welcome Message -->
                        <div class="chat-message d-flex align-items-start mb-4">
                            <div class="bg-primary rounded-3 p-3 me-3 shadow">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div class="bg-white rounded-4 p-4 shadow border flex-grow-1" style="max-width: 70%;">
                                <p class="mb-0 text-dark">
                                    <span data-en="Hello! I'm your CBE Career Assistant powered by Code Champ technology. I can help you explore Kenya's Competency Based Curriculum pathways and find the right career for you. Ask me about subjects, universities, or career prospects!" 
                                          data-sw="Hujambo! Mimi ni Msaidizi wako wa Kazi za CBE unaotumia teknolojia ya Code Champ. Ninaweza kukusaidia kuchunguza njia za Mtaala wa Msingi wa Uwezo wa Kenya na kupata kazi sahihi kwako. Niulize kuhusu masomo, vyuo vikuu, au matarajio ya kazi!">
                                        Hello! I'm your CBE Career Assistant powered by Code Champ technology. I can help you explore Kenya's Competency Based Curriculum pathways and find the right career for you. Ask me about subjects, universities, or career prospects!
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Input Section -->
                    <div class="p-4">
                        <!-- Quick Suggestion Pills -->
                        <div class="d-flex flex-wrap gap-2 mb-4" id="suggestionPills">
                            <button onclick="sendQuickMessage('What are the 4 CBE pathways in Kenya?')" 
                                    class="btn btn-outline-primary btn-sm suggestion-pill border-2">
                                <span data-en="CBE Pathways" data-sw="Njia za CBE">CBE Pathways</span>
                            </button>
                            <button onclick="sendQuickMessage('Which careers are high-paying in Kenya?')" 
                                    class="btn btn-outline-info btn-sm suggestion-pill border-2">
                                <span data-en="High-Paying Jobs" data-sw="Kazi za Mshahara Mkubwa">High-Paying Jobs</span>
                            </button>
                            <button onclick="sendQuickMessage('What universities offer STEM programs?')" 
                                    class="btn btn-outline-warning btn-sm suggestion-pill border-2">
                                <span data-en="Universities" data-sw="Vyuo Vikuu">Universities</span>
                            </button>
                            <button onclick="sendQuickMessage('How do I choose the right career path?')" 
                                    class="btn btn-outline-success btn-sm suggestion-pill border-2">
                                <span data-en="Career Guidance" data-sw="Mwongozo wa Kazi">Career Guidance</span>
                            </button>
                        </div>
                        
                        <!-- Message Input -->
                        <div class="input-group">
                            <input type="text" id="chatInput" 
                                   placeholder="Type your message here..." 
                                   class="form-control form-control-lg border-2"
                                   onkeypress="handleChatKeyPress(event)">
                            <button onclick="clearChat()" class="btn btn-outline-secondary" title="Clear Chat">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="sendMessage()" id="sendButton" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane" id="sendIcon"></i>
                            </button>
                        </div>
                        
                        <!-- Enhanced Features -->
                        <div class="d-flex justify-content-between align-items-center mt-3 text-muted small">
                            <div class="d-flex gap-3">
                                <button onclick="showChatHistory()" class="btn btn-link btn-sm text-decoration-none p-0">
                                    <i class="fas fa-history me-1"></i>
                                    <span data-en="Chat History" data-sw="Historia ya Mazungumzo">Chat History</span>
                                </button>
                                <button onclick="exportChat()" class="btn btn-link btn-sm text-decoration-none p-0">
                                    <i class="fas fa-download me-1"></i>
                                    <span data-en="Export Chat" data-sw="Hamisha Mazungumzo">Export Chat</span>
                                </button>
                                <button onclick="shareChat()" class="btn btn-link btn-sm text-decoration-none p-0">
                                    <i class="fas fa-share me-1"></i>
                                    <span data-en="Share" data-sw="Shiriki">Share</span>
                                </button>
                            </div>
                            <div>
                                <span data-en="Powered by Code Champ AI" data-sw="Inaendeshwa na Code Champ AI">Powered by Code Champ AI</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Features Section -->
                <div class="row g-4 mt-4">
                    <!-- Feature 1 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow">
                            <div class="card-body">
                                <div class="bg-primary bg-opacity-10 rounded-3 p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 48px; height: 48px;">
                                    <i class="fas fa-lightbulb text-primary fs-5"></i>
                                </div>
                                <h5 class="card-title">
                                    <span data-en="Smart Recommendations" data-sw="Mapendekezo Mahiri">Smart Recommendations</span>
                                </h5>
                                <p class="card-text text-muted">
                                    <span data-en="Get personalized career recommendations based on your interests and CBE pathway." 
                                          data-sw="Pata mapendekezo ya kibinafsi ya kazi kulingana na maslahi yako na njia ya CBE.">
                                        Get personalized career recommendations based on your interests and CBE pathway.
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature 2 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow">
                            <div class="card-body">
                                <div class="bg-info bg-opacity-10 rounded-3 p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 48px; height: 48px;">
                                    <i class="fas fa-graduation-cap text-info fs-5"></i>
                                </div>
                                <h5 class="card-title">
                                    <span data-en="Education Guidance" data-sw="Mwongozo wa Elimu">Education Guidance</span>
                                </h5>
                                <p class="card-text text-muted">
                                    <span data-en="Learn about universities, courses, and admission requirements for your chosen career path." 
                                          data-sw="Jifunze kuhusu vyuo vikuu, kozi, na mahitaji ya kujiunga kwa njia ya kazi uliyochagua.">
                                        Learn about universities, courses, and admission requirements for your chosen career path.
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature 3 -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow">
                            <div class="card-body">
                                <div class="bg-warning bg-opacity-10 rounded-3 p-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 48px; height: 48px;">
                                    <i class="fas fa-chart-line text-warning fs-5"></i>
                                </div>
                                <h5 class="card-title">
                                    <span data-en="Career Insights" data-sw="Maarifa ya Kazi">Career Insights</span>
                                </h5>
                                <p class="card-text text-muted">
                                    <span data-en="Discover salary ranges, job market trends, and growth opportunities in Kenya." 
                                          data-sw="Gundua anuwai za mishahara, mienendo ya soko la kazi, na fursa za ukuaji nchini Kenya.">
                                        Discover salary ranges, job market trends, and growth opportunities in Kenya.
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span data-en="Chat History" data-sw="Historia ya Mazungumzo">Chat History</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="chatHistoryContent">
                        <!-- Chat history will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
                    <p class="mb-0 small text-light-emphasis">
                        © 2025 CBE Career Guide. All rights reserved.
                    </p>
                    <p class="mb-0 small text-muted">
                        Code Champ Project - Career Guidance Platform
                    </p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0 small fw-medium">
                        Developed by <span class="text-warning fw-bold">Code Champ</span> 2025
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Backend Configuration
        const BACKEND_URL = 'http://localhost:5173';
        const CHAT_ENDPOINT = `${BACKEND_URL}/api/chat`;
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentUser = null;
        let messageCount = 0;
        let chatHistory = [];
        let isTyping = false;
        let conversationId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            loadChatHistory();
            initializeLanguage();
            checkBackendStatus();
            generateConversationId();
        });

        // Generate unique conversation ID for this session
        function generateConversationId() {
            conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Check backend connectivity
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    updateBackendStatus(true, 'Backend Connected');
                } else {
                    updateBackendStatus(false, 'Backend Error');
                }
            } catch (error) {
                console.error('Backend connection error:', error);
                updateBackendStatus(false, 'Backend Offline');
            }
        }

        function updateBackendStatus(isOnline, statusText) {
            const statusIcon = document.getElementById('statusIcon');
            const statusTextElement = document.getElementById('statusText');
            
            if (isOnline) {
                statusIcon.className = 'fas fa-circle text-success me-1';
                statusTextElement.textContent = statusText;
            } else {
                statusIcon.className = 'fas fa-circle text-danger me-1';
                statusTextElement.textContent = statusText;
            }
        }

        async function checkAuthState() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showLoggedInState();
            } else {
                showLoggedOutState();
            }
        }

        function showLoggedInState() {
            document.getElementById('notLoggedIn').classList.add('d-none');
            document.getElementById('loggedIn').classList.remove('d-none');
            
            if (currentUser.user_metadata?.full_name) {
                document.getElementById('userName').textContent = currentUser.user_metadata.full_name;
            }
        }

        function showLoggedOutState() {
            document.getElementById('notLoggedIn').classList.remove('d-none');
            document.getElementById('loggedIn').classList.add('d-none');
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                showLoggedOutState();
                
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        function initializeLanguage() {
            const languageSelect = document.getElementById('languageSelect');
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            languageSelect.value = savedLanguage;
            changeLanguage();
        }

        async function loadChatHistory() {
            if (!currentUser) return;
            
            try {
                const { data: conversations, error } = await supabase
                    .from('chat_conversations')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('timestamp', { ascending: false })
                    .limit(50);

                if (!error) {
                    chatHistory = conversations;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Enhanced chat functionality
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            messageCount++;
            updateMessageCount();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Save user message to database immediately
            if (currentUser) {
                await saveConversation(message, null, 'user');
                await trackChatInteraction(message);
            }
            
            try {
                // Send message to backend API
                const response = await fetchAIResponse(message);
                hideTypingIndicator();
                addMessageToChat(response, 'bot');
                
                // Save AI response to database
                if (currentUser) {
                    await saveConversation(message, response, 'assistant');
                }
                
                // Update suggestion pills based on response
                updateSuggestionPills(message);
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Error getting AI response:', error);
                addErrorMessage('Sorry, I\'m having trouble connecting to the AI service. Please try again later.');
                
                // Update backend status
                updateBackendStatus(false, 'Connection Failed');
            }
        }

        async function fetchAIResponse(message) {
            try {
                const requestData = {
                    message: message,
                    conversation_id: conversationId,
                    user_id: currentUser?.id || 'anonymous',
                    context: {
                        platform: 'CBE Career Guide',
                        language: localStorage.getItem('selectedLanguage') || 'en',
                        pathway_focus: 'Kenya CBE System'
                    }
                };

                const response = await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Update backend status
                updateBackendStatus(true, 'Backend Connected');
                
                // Return the AI response
                return data.response || data.message || 'I apologize, but I couldn\'t generate a proper response. Please try rephrasing your question.';
                
            } catch (error) {
                console.error('Backend API Error:', error);
                
                // Update backend status
                updateBackendStatus(false, 'API Error');
                
                // Fallback to basic response
                return getFallbackResponse(message);
            }
        }

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Basic fallback responses when backend is unavailable
            if (lowerMessage.includes('pathway') || lowerMessage.includes('cbe')) {
                return "I'm currently having connectivity issues with my main AI service. However, I can tell you that Kenya has 4 main CBE pathways: STEM, Social Sciences, Arts & Sports, and Technical & Vocational. Please try your question again in a moment when my connection is restored.";
            }
            
            if (lowerMessage.includes('university') || lowerMessage.includes('college')) {
                return "I'm experiencing connection issues with my AI backend. For university information, I recommend visiting the official KUCCPS website or contacting universities directly. I'll be back to full functionality shortly.";
            }
            
            return "I apologize, but I'm currently experiencing technical difficulties connecting to my AI service. Please try again in a few moments, or feel free to explore other sections of the CBE Career Guide while I reconnect.";
        }

        function sendQuickMessage(message) {
            const input = document.getElementById('chatInput');
            input.value = message;
            sendMessage();
        }

        function addMessageToChat(message, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message d-flex align-items-start mb-4';
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-grow-1"></div>
                    <div class="bg-primary text-white rounded-4 p-4 shadow ms-auto" style="max-width: 70%;">
                        <p class="mb-0">${escapeHtml(message)}</p>
                    </div>
                    <div class="bg-secondary rounded-3 p-3 ms-3 shadow">
                        <i class="fas fa-user text-white"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="bg-primary rounded-3 p-3 me-3 shadow">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div class="bg-white rounded-4 p-4 shadow border" style="max-width: 70%;">
                        <div class="text-dark">${marked.parse(message)}</div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addErrorMessage(errorText) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'chat-message d-flex align-items-start mb-4';
            errorDiv.innerHTML = `
                <div class="bg-danger rounded-3 p-3 me-3 shadow">
                    <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div class="error-message shadow border" style="max-width: 70%;">
                    <i class="fas fa-wifi me-2"></i>${errorText}
                    <div class="mt-2 small">
                        <button onclick="checkBackendStatus()" class="btn btn-light btn-sm me-2">
                            <i class="fas fa-sync-alt me-1"></i>Retry Connection
                        </button>
                        <button onclick="window.location.reload()" class="btn btn-light btn-sm">
                            <i class="fas fa-refresh me-1"></i>Refresh Page
                        </button>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            isTyping = true;
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-message d-flex align-items-start mb-4';
            typingDiv.innerHTML = `
                <div class="bg-primary rounded-3 p-3 me-3 shadow">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div class="bg-white rounded-4 p-4 shadow border">
                    <div class="d-flex align-items-center text-muted">
                        <div class="typing-indicator me-1 loading-pulse">●</div>
                        <div class="typing-indicator me-1 loading-pulse" style="animation-delay: 0.2s">●</div>
                        <div class="typing-indicator me-2 loading-pulse" style="animation-delay: 0.4s">●</div>
                        <span>AI is thinking...</span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            document.getElementById('sendButton').disabled = true;
            document.getElementById('sendIcon').className = 'fas fa-spinner fa-spin';
        }

        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            document.getElementById('sendButton').disabled = false;
            document.getElementById('sendIcon').className = 'fas fa-paper-plane';
        }

        function updateMessageCount() {
            document.getElementById('messageCount').textContent = messageCount;
        }

        function updateSuggestionPills(lastMessage) {
            const suggestions = document.getElementById('suggestionPills');
            const lowerMessage = lastMessage.toLowerCase();
            
            // Update suggestions based on conversation context
            if (lowerMessage.includes('pathway')) {
                suggestions.innerHTML = `
                    <button onclick="sendQuickMessage('Tell me more about STEM careers')" class="btn btn-outline-primary btn-sm suggestion-pill">STEM Careers</button>
                    <button onclick="sendQuickMessage('What about Social Sciences?')" class="btn btn-outline-success btn-sm suggestion-pill">Social Sciences</button>
                    <button onclick="sendQuickMessage('Show me Arts & Sports options')" class="btn btn-outline-info btn-sm suggestion-pill">Arts & Sports</button>
                `;
            } else if (lowerMessage.includes('university')) {
                suggestions.innerHTML = `
                    <button onclick="sendQuickMessage('What are the admission requirements?')" class="btn btn-outline-primary btn-sm suggestion-pill">Admission Requirements</button>
                    <button onclick="sendQuickMessage('Tell me about scholarship opportunities')" class="btn btn-outline-success btn-sm suggestion-pill">Scholarships</button>
                    <button onclick="sendQuickMessage('Which universities are best for my interests?')" class="btn btn-outline-info btn-sm suggestion-pill">Best Universities</button>
                `;
            }
        }

        async function saveConversation(message, response, role) {
            if (!currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('chat_conversations')
                    .insert([
                        {
                            user_id: currentUser.id,
                            conversation_id: conversationId,
                            message: message,
                            response: response,
                            role: role,
                            timestamp: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error saving conversation:', error);
            }
        }

        async function trackChatInteraction(message) {
            if (!currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('user_activities')
                    .insert([
                        {
                            user_id: currentUser.id,
                            activity_type: 'chat_interaction',
                            activity_data: { 
                                message_preview: message.substring(0, 50),
                                conversation_id: conversationId
                            },
                            timestamp: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error tracking chat interaction:', error);
            }
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            // Keep only the welcome message
            const welcomeMessage = chatContainer.firstElementChild;
            chatContainer.innerHTML = '';
            chatContainer.appendChild(welcomeMessage);
            messageCount = 0;
            updateMessageCount();
            
            // Generate new conversation ID for the new session
            generateConversationId();
        }

        function showChatHistory() {
            const historyContent = document.getElementById('chatHistoryContent');
            
            if (chatHistory.length === 0) {
                historyContent.innerHTML = '<div class="text-center text-muted py-5">No chat history available</div>';
            } else {
                historyContent.innerHTML = chatHistory.map(chat => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">${formatDate(chat.timestamp)}</small>
                                <span class="badge bg-primary">${chat.conversation_id || 'Session'}</span>
                            </div>
                            <div class="mb-2">
                                <div class="bg-primary bg-opacity-10 rounded p-3 mb-2">
                                    <strong>You:</strong> ${escapeHtml(chat.message)}
                                </div>
                                ${chat.response ? `
                                    <div class="bg-light rounded p-3">
                                        <strong>AI:</strong> ${escapeHtml(chat.response)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        function exportChat() {
            const chatMessages = document.querySelectorAll('.chat-message');
            const chatData = Array.from(chatMessages).map(msg => {
                const isUser = msg.querySelector('.fa-user');
                const textElement = msg.querySelector('p, div');
                const text = textElement ? textElement.textContent.trim() : '';
                return {
                    sender: isUser ? 'User' : 'AI',
                    message: text,
                    timestamp: new Date().toISOString()
                };
            }).filter(item => item.message && !item.message.includes('AI is thinking'));

            const exportData = {
                session_date: new Date().toISOString(),
                conversation_id: conversationId,
                message_count: messageCount,
                backend_url: BACKEND_URL,
                user_id: currentUser?.id || 'anonymous',
                messages: chatData
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cbe_chat_${conversationId}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSuccessMessage('Chat exported successfully!');
        }

        function shareChat() {
            const chatUrl = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'CBE Career Chat',
                    text: 'I had a helpful conversation with the CBE Career AI Assistant',
                    url: chatUrl
                });
            } else {
                navigator.clipboard.writeText(chatUrl);
                showSuccessMessage('Chat link copied to clipboard!');
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function showSuccessMessage(message) {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1050';
            toastContainer.innerHTML = `
                <div class="toast align-items-center text-white bg-success border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-check-circle me-2"></i>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toastContainer);
            
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            setTimeout(() => {
                toastContainer.remove();
            }, 3000);
        }

        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            const currentLanguage = select.value;
            localStorage.setItem('selectedLanguage', currentLanguage);
            
            document.querySelectorAll('[data-en]').forEach(element => {
                if (currentLanguage === 'en') {
                    element.textContent = element.getAttribute('data-en');
                } else {
                    element.textContent = element.getAttribute('data-sw');
                }
            });
        }

        // Show auth section after page load
        document.getElementById('authSection').classList.remove('d-none');

        // Check backend status periodically
        setInterval(checkBackendStatus, 30000); // Check every 30 seconds
    </script>

</body>
</html>